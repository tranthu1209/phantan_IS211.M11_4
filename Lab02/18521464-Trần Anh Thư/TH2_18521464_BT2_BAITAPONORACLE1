--4. Hiện thực ràng buộc toàn vẹn sau: Ngày bắt đầu chuyến bay luôn lớn hơn ngày thành lập hãng hàng không quản lý chuyến bay đó.--
CREATE OR REPLACE TRIGGER CB_HHK
AFTER INSERT OR UPDATE ON BTCNTT3.CHUYENBAY
FOR EACH ROW
DECLARE
	HHK_NGTL DATE;
BEGIN
	SELECT NGTL into HHK_NGTL FROM BTCNTT3.HANGHANGKHONG WHERE MAHANG=:NEW.MAHANG;
	If (:NEW.BATDAU <= HHK_NGTL) THEN
		RAISE_APPLICATION_ERROR(-20100, 'NGAY BAT DAU CHUYEN BAY PHAI LON HON NGAY THANH LAP HANG HANG KHONG QUAN LY CHUYEN BAY DO!');
	END IF;
END;

CREATE OR REPLACE TRIGGER HHK_CB
AFTER UPDATE ON BTCNTT3.HANGHANGKHONG
FOR EACH ROW
DECLARE
	CB_BATDAU DATE;
BEGIN
	SELECT BATDAU INTO CB_BATDAU FROM BTCNTT3.CHUYENBAY WHERE MAHANG=:NEW.MAHANG;
	If (:NEW.NGTL >= CB_BATDAU) THEN
		RAISE_APPLICATION_ERROR(-20100, 'NGAY BAT DAU CHUYEN BAY PHAI LON HON NGAY THANH LAP HANG HANG KHONG QUAN LY CHUYEN BAY DO!');
	END IF;
END;

DROP TRIGGER HHK_CB

--TEST--
INSERT INTO BTCNTT3.CHUYENBAY VALUES('VN551', 'VN', N'TP.HCM', N'Singapore', '20/12/1950 13:15', 2);

UPDATE BTCNTT3.CHUYENBAY
SET BATDAU = '01/01/1950 00:00'
WHERE MACB = 'VN550';

UPDATE BTCNTT3.HANGHANGKHONG
SET NGTL = '01/01/2021 00:00'
WHERE MAHANG = 'VN';
--UPDATE HANG HANG KHONG CO NHIEU CHUYEN BAY BI LOI, MONG ANH CHI CACH LAM KHAC--

